# 小程序开发

- Winter bells

APPID： wxcfcf0e94ef634809

AppSecret:62b11ab6025c17349e0de9104174ab4d

环境ID：wangs-8god2agcd87d8668

准备环境：在D:\NeteaseCloudMusicApi 目录下 cmd输入node app.js
          uTools内网穿透

## 小程序准备

- 填写小程序注册信息（保存小程序的AppID和AppSecret）
- 填写小程序信息（小程序的头像可以用蒲公英工具箱自己制作）
- 下载微信开发者工具（默认安装）
- 创建小程序
- 打开（设置-安全设置-服务端口），勾选（详情-本地设置-增强编译&不效验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书）
- 创建云开发环境
- 点击获取openid（调用失败，重新登录）

## 教程

[教程](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%AE%80%E4%BB%8B)

环境ID：（云开发-设置）

console.log(显示提示信息)

云函数最后一个不用加逗号

[矢量图标](https://www.iconfont.cn/home/index?spm=a313x.7781069.1998910419.2 )

## 规范

定义变量：var  let(局部变量)  const(确定的值)

```javascript
 const name='wang'
    const person={
      name,
      age:30,
    }
```

const name='wang' 后不加分号

简写 name 放上面

最后一个值 age:30 后面加逗号

[编码规范](https://github.com/airbnb/javascript)

## 组件

### swiper（滑块视图容器）

| 属性                   | 类型    | 默认值             | 说明                         |
| ---------------------- | ------- | ------------------ | ---------------------------- |
| indicator-dots         | boolean | false              | 是否显示面板指示点           |
| indicator-color        | color   | rgba(0, 0, 0, .3)  | 指示点颜色                   |
| indicator-active-color | color   | \#000000           | 当前选中的指示点颜色         |
| autoplay               | boolean | false              | 是否自动切换                 |
| current                | number  | 0                  | 当前所在滑块的 index         |
| interval               | number  | 5000（单位：毫秒） | 自动切换时间间隔             |
| duration               | number  | 500（单位：毫秒）  | 滑动动画时长                 |
| circular               | boolean | false              | 是否采用衔接滑动             |
| vertical               | boolean | false              | 滑动方向是否为纵向           |
| easing-function        | string  | "default"          | 指定 swiper 切换缓动动画类型 |

#### **easing-function 的合法值**

| 值             | 说明         |
| -------------- | ------------ |
| default        | 默认缓动函数 |
| linear         | 线性动画     |
| easeInCubic    | 缓入动画     |
| easeOutCubic   | 缓出动画     |
| easeInOutCubic | 缓入缓出动画 |

注意：

- 一次显示多个文件：设置-编辑器设置-总是在新标签页打开文件
- 小程序中调大小不用px，用rpx
- 右击-（检查）-复制图片地址。[图片转换为Base64编码](http://www.bejson.com/ui/image2base64/)
- [node.js安装](https://blog.csdn.net/antma/article/details/86104068?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522161171361316780299099606%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fall.%252522%25257D&request_id=161171361316780299099606&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-1-86104068.first_rank_v2_pc_rank_v29&utm_term=node.js%25E7%258E%25AF%25E5%25A2%2583%25E6%2580%258E%25E4%25B9%2588%25E5%25AE%2589%25E8%25A3%2585)
- uTools快捷键：Alt+空格

## 云数据库

步骤：1.启动网易云音乐API
2.用uTools做内网穿透
3.建云函数
4.建云数据库
5.云函数环境（云函数-右击-在内建终端中打开；输入命令：npm install --save axios，安装网络请求库axios）
6.编写云函数入口文件（使用通过postman测试的接口地址）
注意：node.js项目的窗口不要关，保证它一直正常运行；检查内网穿透工具，网络环境变化会导致断开；云函数每次修改后一定要重新上传部署

## 歌单→歌曲→播放

### 歌单→歌曲：

1.调用API接口
2.在app.js添加新页面到pages
3.在components目录找到歌单组件，在playlist.wxml中绑定tap事件
4.在playlist.js中进行页面跳转，musiclist.js中在onLoad函数中接收这个参数:console.log（）（使用wx.navigateTo()进行页面跳转，目标页面会自带返回按钮）
5.添加并修改编译模式，可将musiclist页面作为启动页，查看效果较为方便
6.将歌单id在music云函数中用parseInt转一下
7.调用云函数，传递歌单id 和 路由参数
8.编写页面顶部歌单及歌曲列表信息
9.编写musiclist组件

### 歌曲→播放：

1.歌曲列表高亮，跳转播放页
2.绑定确认点击有反应
3.自定义属性musicid，区分点击显示效果
4.定义高亮样式，使点击歌曲高亮
5.定义索引属性index
6.准备目标页面，实现点击歌曲跳转播放歌曲页面

### 音乐播放页布局

1.注册阿里云账号，将播放页所需的图片上传到OSS
2.根据歌曲id获取歌曲播放的url。（只修改一个文件的代码，可将这个文件右击单独上传云函数，更新文件；展示在页面上放入data；当属性名和属性值一样的时候可以省略，只写一个，并将其放在第上面。）
3.编写全屏毛玻璃效果。
4.用iconfont找合适的矢量图标，加入购物车，在购物车中加入项目，获取css代码。
5.在小程序的根目录下，新建一个iconfont.wxss；放一个图标尝试，并调整大小颜色。
6.编写播放页player.wxml，并调整样式player.wxss

### 播放页动画交互效果及播放功能

1.在player.js中设一个变量isPlaying来记录歌曲的播放状态，默认歌曲没有被播放，为false。（在页面中设置受控制的按钮，应把它放在data中。）
2.获取歌曲的url，如果这个url为空，提示没有播放权限，则直接结束；如果url不为空，则直接播放。（右击文件-在侧边打开，可一次显示两个文件内容，方便编写页面和页面数据的调整。）
3.调整播放/停止按钮，让按钮可以点击切换。
4.让唱片转动，并设置转动内容、转动时间、转动方式、转动次数。
5.定义唱片的关键帧。（开始和结束位置）
6.调整player.wxml中的转和停，让唱片停在转动时的位置。
7.给唱针播放状态设置一个伪元素，让唱针随着唱片的转动或停止切换位置。（在唱针样式中，加入一个transition属性，让唱针切换位置时更平滑。）

### 歌词组件

1.点击事件控制元素是否显示

- 创建歌词组件lyric，引入到歌曲播放界面
- 在封面上定义点击事件`bind:tap="onLyricShow"`
- 在脚本中我们定义一个全局布尔变量，判断当前是歌词还是封面
- 在事件中进行取反数据绑定，并隐藏之前一个组件，组件中也是用对应的事件进行取反操作
- 在组件中响应变量变化
- 定义他的类型和数值，并在前端响应相应隐藏

2.歌词显示

- 在当前歌曲加载成功后在显示歌词，因为不需要一显示就加载歌词
- 所以在加载完封面之类的首要显示内容在请求单词
- 首先当前是从云函数中请求我们的歌词资源，请求后在页面请求调用。判断当前歌词的情况，并进行字符串装换
- 在前台将我们的绑定数据进行传送，传递给组件`lyric="{{lyric}}"`

- 在组件中接受，并通过属性监听器来监听数据
  `observers:{ lyric(lrc){ console.log(lrc) } },`

3.解析歌词

- 在获取到资源的情况下，将我们的歌词逐行解析，显示在桌面上，通过每一个换行，来判断每一行的歌词

- 在获取到每一行的歌词后，循环逐行解析，使用正则表达式来区分时间。然后通过时间来获取每一行对应的歌词，将他们都放在_lrcList上以供输出，然后在组件前台获取对应的值，并且设置歌词样式

4.歌词与播放时间联动

- 在歌曲开始播放的时候，会触发一个timeUpdate事件，即监听当前音乐的播放进度，所以我们在当前事件中是可以监听到歌词和歌词播放时间的关系的
- 在我们进度条组件中的timeUpdate事件通过自定义事件将时间传递出去
- 在歌词组件使用中使用该自定义事件。响应事件内容，使用内置函数取到我们的组件，将内容传递过去。通过对应的函数取到歌词对应时间,写关联语句，让歌词与时间相关联

5.歌词随时间变化向上移动

- 因为移动的问题，所以原来歌词的组件就是使用的是动态的scroll-view组件，里边有内置属性可以移动，设置滚动方向和滚动高度
- 在我们设置歌词的时候设置了高度为64rpx,但是我们自定义的scrollTop为px像素。所以我们要考虑怎么让两个单位可以转换
- 在微信中，有一个内置函数，可以获取当前手机信息wx.getSystemInfo在返回正确的函数中，我们将获取到的手机宽度除以（默认小程序宽度750rpx），可以得到当前1rpx的大小是多少。让他乘上64 ，可以得到每一句的高度。
- 用我们自定义的高度属性lyricHeight来接收每一行的高度，进行数据绑定，让他乘上索引值，可以得到滚动条滚动的高度了
- 对scroll-view组件配置scroll-with-animation="true"属性

### 导航栏

- json文件中设置导航栏样式自定义`"navigationStyle":"custom"`，设置后可隐藏除右侧胶囊外的所有头部导航栏

- 在js文件中获取当前手机的顶部状态栏高度

- 用wx.getSystemInfoSync()获取系统信息，里面有个参数：statusBarHeight（状态栏高度）

- 用wx.getMenuButtonBoundingClientRect()可以获取胶囊按钮的布局位置信息，坐标信息以屏幕左上角为原点

- 导航栏高度 = 状态栏到胶囊的间距（胶囊距上距离-状态栏高度） \* 2 + 胶囊高度 + 状态栏高度

- 编写wxml内容

- 在wxss文件中设置定位为fixed（如果设置absolute，当页面超出原本高度后，会出现顶部只有胶囊移动的情况）

  注意设置好间距，因为fixed定位会遮盖下方的内容

  - 背景颜色渐变`background: -webkit-linear-gradient(left,white,lightblue,rgb(83, 201, 248));`

### 自定义导航栏组件

- 因为不同的手机型号头部导航栏高度可能不一致，所以为了适配更多型号，需要动态计算导航栏的高度

- 微信小程序中，状态栏高度可以通过 wx.getSystemInfo(）获取

- 胶囊信息可以通过 wx.getMenuButtonBoundingClientRect() 获取；所以导航栏高度=状态栏高度+胶囊按钮的高度+（胶囊按钮距离顶部的距离-状态栏的高度）*2

- 新建navigation组件，编写组件，想要改变右上角胶囊按钮的颜色，可以在app.json中设置window的属性navigationBarTextStyle

- 在要使用自定义导航栏的页面的JSON文件中进行如下设置：微信小程序导航栏样式navigationStyle，支持以下值：default 默认样式；custom 自定义导航栏，自定义导航栏只保留右上角胶囊按钮

- 在要使用自定义导航栏的页面WXML文件中使用即可

  ```html
  <navigation showIcon='{{false}}' isTransparent='{{true}}' title='发现'></navigation>
  ```

### 自定义搜索组件

#### 思路：

- 为了适应各种返回格式不同的接口，组件应该直接接收一个数组，数据请求最好由父页面完成，后台返回的数据可能不是字符串数组，更有可能是对象数组，因此还要有参数指定显示的属性名
- 搜索却是在组件中进行的，所以搜索内容要传给父级页面作为接口参数，接口需要做节流
- 选中后将选中的下标返回父页，然后执行回调，因为很多选中后还会联动其余值的填入，其他数据一般也在选中的对象中，在父页面用下标直接从数组中获取就可以了

#### 步骤：

- 组件名为search，在开发工具右键新建Components，由于组件内及父页面都能控制组件的显示隐藏（组件内是选中后直接隐藏），所以隐藏状态要保持一致，否则会出现父页面触发了却不显示的问题
- 编写组件
- 组件使用时，在使用页面的json中要声明
- 在组件使用页面的js页面，组件参数回调

### 登录授权组件&弹框组件

- 先编写弹窗组件。用userInfo判断用户是否登录，用VSCode编写bottom-modal.scss

- 把弹框组件引入登录授权组件
- 编写登录授权组件
- 把登录授权组件引入find界面
- 添加发现界面代码。发布按钮绑定底部弹框

### 发布页面布局和图片交互处理

-  定义输入文字最大的个数、最大上传图片数量、输入的文字内容、当前选择图片上传的最大数量等
- 用onInput计算输入字的个数
- 用onFocus对键盘高度处理
- 当输入文字时，用onBlur将底部往上偏移;添加图片时，再移回
- 用onChooseImage计算，选图片前后还能再选几张图片（最多九张）
- 用父相子绝在图片的右上角添加一个删除图标

#### SCSS和CSS的区别

- SCSS包含CSS的所有功能，并且包含CSS中不存在的更多功能。 SCSS可以使用变量、嵌套的方法来缩短代码。

#### 异步操作

- 异步指的是每一个任务有一个或多个回调函数，前一个任务结束后，不是执行后一个任务，而是执行回调函数，后一个任务则是不等前一个任务结束就执行，所以程序的执行顺序与任务的排列顺序是不一致的、异步的。（Promise是一种异步操作，.then是Promise的方法，所以.then也是一种异步操作）

#### 博客模糊搜索功能

- 在云函数index.js中添加keyword，判断是否有关键词，有则显示含关键词的列表，并排序（一定要重新上传并部署）
- 给搜索组件添加keyword
- 给搜索按钮绑定事件

#### 博客评论功能

- 新建blog-ctrl组件，引入之前封装的授权登录组件login和底部弹框组件（编写布局及样式）
- 在云数据库新建一个blog-comment集合，用来存放博客评论

#### 博客详情页

- blog云函数需要编写根据博客id获取博客详情的代码，这里涉及到聚合和联表查询（在两个不同的集合）
- 注意aggregate、match、lookup的用法
- 在博客卡片上绑定tap事件，点击可以跳转到博客详情页，同时将该博客的id作为自定义属性data-blogid进行传递
- 博客卡片组件的图片点击用的是catch:tap，而不是bind:tap，是为了阻止事件冒泡，点击图片预览，点击整个卡片可以跳转到详情页
- goDetail事件处理函数，从事件的target.dataset中取得博客id，然后作为参数跳转到博客详情页
- *引入博客组件和博客控制组件*
- 底部操作条在使用blog-ctrl组件的时候，绑定了refreshCommentList方法，这样在blog-ctrl组件评论成功后，可以触发它，从而去刷新详情页（重新请求下博客详情）
- 评论成功触发父组件刷新方法在blog-ctrl组件的js，发布成功评论后，触发一下父组件的刷新方法，这样就可以在详情页实时看到评论的内容了

#### 个人中心

- 在我的界面profile.json中加入` "disableScroll":true ` 让页面不滚动
- 要调试最近播放功能，需要在音乐播放页面，将当前播放的歌曲加入播放历史记录的本地存储 ，并且去重
- 在**全局中**编写获得openid的方法
-  一定记得先在play.js头部，引入app对象
-  编写savePlayHistory方法，用于保存播放历史； 当开始播放一首歌曲时，调用这个方法
- 根据openid获得作者的所有博客并分页，写完增量上传

#### 个人界面

- 使用open-data中的type方法获得头像及昵称
- 实现页面跳转用navigator方法，` hover-class="none" `去掉点击变灰效果
- 把背景图上传到阿里云OSS中，并将地址代入.scss中；在.scss中编写背景图、获取的头像和昵称、列表及上面各个内容的样式
- 在.js中制作一个生成小程序码的加载过程onTapQrCode方法，调用云函数生成小程序码，生成小程序码的预览图片

#### 获取小程序码云函数

- 新建一个getQrCode云函数获取小程序码，将获取的小程序码上传到云函数，再从云函数中获取（不需要安装依赖，一定要上传部署）

#### app.js

- 编写获得openid的方法，可以全局调用

#### 最近播放

- 在.json中插入歌单组件；页面上只显示顶部导航栏和最近播放的歌单，给顶部导航栏添加标题
- 直接使用歌单组件的样式，不用编写.scss
- 在.js中使用` const app = getApp `获取全局变量
- 因为只显示歌单，data里面只添加musiclist
- 取出本地存储key为openid的数据，当最近没有播放时跳出播放历史为空的弹框
- 用wx.setStorage方法将歌单替换成播放历史的歌单

#### 播放界面

- 在.js中使用` const app = getApp `获取全局变量
- 使用savePlayHistory方法保存当前正在播放的歌曲，根据openid取出本地存储（同步）
- 判断本地是否已经保存当前播放歌曲，已经存在则不保存结束循环；不存在则将当前播放歌曲加入最近播放歌单的最上面，更新本地存储（异步）

#### 我的博客

- 编写我的博客界面，筛选出本人发布的博客，只显示发布人的头像、时间及文本，点击博客卡片的任意地方跳转至详情页，左滑删除
- _getListByCloud方法从云函数中获取我的博客列表，点击跳转至详情页

- 用handleMovableChange方法使博客卡片可以左滑，handleDelete让博客卡片在界面和数据库中同时删除
# 总结

​    又一轮“团码”阶段性告终，其实别说你们，我自己也在这一轮复一轮的练习中不断地成长，比如对整个节奏的把控，比如在短时间内如何让学习者效率最大化，比如给初学者搭建比较科学易懂的学习路径。

​    比如，对自己的期待和规划。

​    依然会欣赏所有努力的人，所有坚持的人，所有志同道合的人。

​    所有的进步，都源自对自身苛刻的要求，而不是得过且过。

 **最后总结一下这20天的学习要点吧**

- 小程序云开发的环境搭建

- node.js和npm环境搭建

- VS Code安装、插件使用

- git和github

- SCSS预处理样式，结合插件自动编译提升编码效率

- 小程序的代码结构

- 小程序的常用布局容器、组件、API、原生组件

- 自定义组件的编写步骤、思想、使用

- iconfont的各种使用姿势

- OSS服务及工具

- 云函数的写法和注意事项

- tcb-router的使用

- 云数据库编程起步（更多操作看文档摸索即可），这里尤其做了关联和聚合操作，这个在以前的SDK版本是不支持的

- JSON数据的各种解析

- 各种页面跳转姿势、传值

- 自定义导航

- 父子组件通信

- 组件slot插槽的妙用

- 巧用自定义属性data-处理事件传值问题

- flex布局从入门到熟练

- CSS3动画

- 父相子绝、padding、margin、fixed、absolute、relative

- JS代码规范、一些ES6高级特性、异步编程等

- 很多细节的处理，友好的提示

- 每天有输出的成就感和快乐
